---
title: "Regression_HW1"
output:
  html_document:
    df_print: paged
---


```{r}
library(ggplot2)
library(corrplot)
library(MASS)
library(skimr)
library(readr)
library(VIF)
library(fastDummies)
library(janitor)
library(stringr)
library(dplyr)
```

# load data
```{r}
data_bank <- read_csv("bankrevenue.csv") %>% clean_names()
data_bank
```


# mutate rev_total and bal_total to numeric
```{r}
data_bank %>%
  mutate(rev_total = as.numeric(str_sub(rev_total,2,-1))) %>%
  mutate(bal_total = str_sub(bal_total,2,-1)) %>%
  mutate(bal_total = as.numeric(gsub(",","",bal_total))) -> data_br
data_br %>%
  skim_without_charts()
```

# full model
## Residuals plot not symmetric 
```{r}
full_reg <- lm(rev_total~., data_br)
full_reg
summary(full_reg)
plot(full_reg)
ggplot(data_br,aes(x=resid(full_reg)))+geom_histogram()
```



# reg1 for log(y) model
## Residuals plot is symmetric
```{r}

reg1 <- lm(log10(rev_total)~., data_br)
reg1
summary(reg1)
plot(reg1)
ggplot(data_br,aes(x=resid(reg1)))+geom_histogram()
```

# reg2 for bal_total, age, account_age in log(x), log(y)
## Residuals plot is better
```{r}
data_br1 <-
  data_br %>%
  mutate(bal_total = log10(bal_total), 
         age = log10(age), 
         account_age = log10(account_age)) %>%
  filter(bal_total != -Inf,!is.na(bal_total), !is.nan(bal_total),
         age != -Inf,!is.na(age),!is.nan(age),
         account_age != -Inf,!is.na(account_age),!is.nan(account_age))

reg2 <- lm(log10(rev_total)~., data_br1)
reg2
summary(reg2)
plot(reg2)
ggplot(data_br1,aes(x=resid(reg2)))+geom_histogram()
```

# reg3 for bal_total, account_age in log(x), log(y)
## since the p-value for not logging age is smaller than logging age, I choose not to log it.
```{r}
data_br2 <-
  data_br %>%
  mutate(bal_total = log10(bal_total), 
         account_age = log10(account_age)) %>%
  filter(bal_total != -Inf,!is.na(bal_total), !is.nan(bal_total),
         account_age != -Inf,!is.na(account_age),!is.nan(account_age))

reg3 <- lm(log10(rev_total)~., data_br2)
reg3
summary(reg3)
plot(reg3)
ggplot(data_br2,aes(x=resid(reg3)))+geom_histogram()
```

# step model
## bal_total, offer, card, loan, insur, check, account_age left
```{r}
step <- stepAIC(reg3, direction="both")
summary(step)
plot(step)
ggplot(data_br2,aes(x=resid(step)))+geom_histogram()
```

# check step model for multicollinearity
## We can seed that card has a vif > 5 
```{r}
vifres <- car::vif(step)
vifres
```

# remove card in reg4
## p-value for insur is larger than 0.05
```{r}
reg4 <- lm(log10(rev_total)~ bal_total + offer + loan + insur + check + account_age, data_br2)
summary(reg4)
plot(reg4)
ggplot(data_br2,aes(x=resid(reg4)))+geom_histogram()
```

# remove insur in reg5
## all of p-values are under 0.05
```{r}
reg5 <- lm(log10(rev_total)~ bal_total + offer + loan + check + account_age, data_br2)
summary(reg5)
plot(reg5)
ggplot(data_br2,aes(x=resid(reg5)))+geom_histogram()
```
# check reduced model for multicollinearity
## every vif value are under 5 this time. This is my final model.
```{r}
vifres <- car::vif(reg5)
vifres
```

# Conclusion
According to this model, we can see that rev_total(the total revenue generated by the customer over a 6 month period) is related with Bal_Total, Offer, Loan, Check and Account_age. 
The equation of this model is:
log10(rev_total)=-1.119 + 0.371*bal_total + 0.457*offer + 0.0762*loan - 0.274*check + 0.066*log10(account_age)
So that if bank want to increase the total revenue, they should increase the total account balance accross all customers, and to have more customers who have just received promotional letter, customers who have higher personal loan account activity, customers who have low or no activity for personal loan account, and customers have more years to be a customer of the bank.